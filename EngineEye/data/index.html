<!DOCTYPE html>
<html>

<head>
    <!--Engine Monitor HTML-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Engine Parameters</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <!--link rel="stylesheet" type="text/css" href="w3.css"-->
    <link rel="stylesheet" type="text/css" href="Chart.min.css">
    <script src="Chart.min.js.gz"></script>


    <script type="text/javascript">
        function hotText(elemID, level) {
            var tempelem = document.getElementById(elemID);
            var tempnum = parseInt(tempelem.innerHTML, 10);

            if (tempnum > level) {
                tempelem.style.color = "red";
            } else {
                tempelem.style.color = "black";
            }
        }

        var webSocket, dataPlot;
        var maxDataPoints = 20;

        function removeData() {
            dataPlot.data.labels.shift();
            dataPlot.data.datasets[0].data.shift();
            dataPlot.data.datasets[1].data.shift();
        }

        function addData(label, data0, data1) {
            if (dataPlot.data.labels.length > maxDataPoints) removeData();
            dataPlot.data.labels.push(label);
            dataPlot.data.datasets[0].data.push(data0);
            dataPlot.data.datasets[1].data.push(data1);
            dataPlot.update();
        }

        function init() {
            webSocket = new WebSocket('ws://' + window.location.hostname + ':81/');
            webSocket.onmessage = function(event) {
                processReceivedCommand(event);
            };

            dataPlot = new Chart(document.getElementById("line-chart"), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        label: "RPM",
                        yAxisID: 'A',
                        borderColor: "#3e95cd",
                        fill: false
                    }, {
                        data: [],
                        label: "dwell",
                        yAxisID: 'B',
                        borderColor: "#6f3d8e",
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        yAxes: [{
                            id: 'A',
                            type: 'linear',
                            position: 'left',
                            ticks: {
                                fontColor: "#3e95cd",
                                max: 5000,
                                min: 500
                            }
                        }, {
                            id: 'B',
                            type: 'linear',
                            position: 'right',
                            ticks: {
                                fontColor: "#6f3d8e",
                                max: 70,
                                min: 30
                            }
                        }]
                    }
                }
            });
        }

        function processReceivedCommand(evt) {
            var data = JSON.parse(evt.data);
            document.getElementById('revs').innerHTML = data.rpm;
            document.getElementById('voltage').innerHTML = data.voltage;
            document.getElementById('temp2F').innerHTML = data.temp2;
            document.getElementById('rev_meter').value = data.rpm;
            document.getElementById('volt_meter').value = data.voltage;
            document.getElementById('temp2_meter').value = data.temp2;

            var today = new Date();
            var t = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
            addData(t, data.rpm, data.dwell);

            hotText("temp2F", 250);
            hotText("voltage", 14.5);
            hotText("revs", 4100);
        }

        function closesocket() {
            webSocket.close();
        }
    </script>
</head>

<body onload="javascript:init()" onbeforeunload="return closesocket()">
    <div class="main_block">

        <div class="section temp">
            <!--h3> <span id="temp2F_title">Oil Temperature</span> </h3-->
            <meter id="temp2_meter" value="0" min="50" max="300">oil temp</meter>
            <h3> Oil <span id="temp2F">--</span> deg F </h3>
        </div><br>

        <div class="section rpm" onclick="location.href='rpm.html';">
            <!--h3> <span id="rev_title">Revolutions / Min</span> </h3-->
            <meter id="rev_meter" value="0" min="0" max="6000">rpm</meter>
            <h3> <span id="revs">--</span> RPM</h3>
        </div><br>

        <div class="chart">
            <canvas id="line-chart" width="300px" height="300px"></canvas>
        </div>

        <div class="section volt">
            <!--h3> <span id="voltage_title">Generator Voltage</span> </h3-->
            <meter id="volt_meter" value="0" min="0" max="15">gen volts</meter>
            <h4> Generator <span id="voltage">--</span> V</h4>
        </div>

    </div>
</body>

</html>